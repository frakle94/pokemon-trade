<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokémon Trade Platform</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center">Pokémon Trade Platform</h1>

        <!-- Registration and Login Section -->
        <div class="card mt-4">
            <div class="card-body">
                <h3>Register or Login</h3>
                
                <!-- Registration -->
                <form id="registerForm">
                    <h5>Register</h5>
                    <div class="mb-3">
                        <label for="reg_username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="reg_username" required>
                    </div>
                    <div class="mb-3">
                        <label for="reg_password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="reg_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="reg_pokemon_id" class="form-label">Pokémon ID</label>
                        <input type="text" class="form-control" id="reg_pokemon_id" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                </form>

                <hr>

                <!-- Login -->
                <form id="loginForm">
                    <h5>Login</h5>
                    <div class="mb-3">
                        <label for="login_username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="login_username" required>
                    </div>
                    <div class="mb-3">
                        <label for="login_password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="login_password" required>
                    </div>
                    <button type="submit" class="btn btn-success">Login</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null; // To store user data after login/registration

        // Navigate to features after registration or login
        function navigateToFeatures(username, pokemonId, password) {
            currentUser = { username, pokemonId, password }; // Save current user details
            document.body.innerHTML = `
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <div class="container-fluid">
                        <a class="navbar-brand">Pokémon Trade Platform</a>
                        <button class="btn btn-outline-primary" onclick="showProfile()">Profile</button>
                    </div>
                </nav>
                <div class="container mt-5">
                    <h1 class="text-center">Welcome, ${username}!</h1>
                    <p class="text-center">Now you can offer and search for Pokémon.</p>
                    <div class="text-center">
                        <button class="btn btn-primary" onclick="offerPokemon()">Offer Pokémon</button>
                        <button class="btn btn-success" onclick="searchPokemon()">Search Pokémon</button>
                    </div>
                    <div id="actionArea" class="mt-4"></div>
                </div>`;
        }

        // Show Profile with logout and update options
        function showProfile() {
            document.body.innerHTML = `
                <div class="container mt-5">
                    <h1 class="text-center">Your Profile</h1>
                    <form id="updateProfileForm">
                        <div class="mb-3">
                            <label for="profile_username" class="form-label">Username</label>
                            <input type="text" class="form-control" id="profile_username" value="${currentUser.username}" required>
                        </div>
                        <div class="mb-3">
                            <label for="profile_pokemon_id" class="form-label">Pokémon ID</label>
                            <input type="text" class="form-control" id="profile_pokemon_id" value="${currentUser.pokemonId}" required>
                        </div>
                        <div class="mb-3">
                            <label for="profile_password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="profile_password" value="${currentUser.password}" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Profile</button>
                        <button type="button" class="btn btn-danger mt-3" onclick="logout()">Logout</button>
                    </form>
                </div>`;

            document.getElementById('updateProfileForm').addEventListener('submit', function (e) {
                e.preventDefault();
                
                // Get updated values from the profile form
                const newUsername = document.getElementById('profile_username').value;
                const newPokemonId = document.getElementById('profile_pokemon_id').value;
                const newPassword = document.getElementById('profile_password').value;
                
                // Log the data being sent to the backend
                console.log({
                    old_username: currentUser.username,
                    username: newUsername,
                    pokemon_id: newPokemonId,
                    password: newPassword
                });
                
                // Send the update request to the backend
                axios.put('/user/update', {
                    old_username: currentUser.username, // Current username
                    username: newUsername,             // Updated username
                    pokemon_id: newPokemonId,          // Updated Pokémon ID
                    password: newPassword              // Updated password
                })
                .then(response => {
                    alert(response.data.message);

                    // Update currentUser details
                    currentUser.username = newUsername;
                    currentUser.pokemonId = newPokemonId;
                    currentUser.password = newPassword;

                    // Navigate back to the main features page
                    navigateToFeatures(newUsername, newPokemonId, newPassword);
                })
                .catch(error => {
                    alert('Error updating profile: ' + (error.response?.data?.message || error.message));
                });
            });                                                
        }

        // Logout and return to the login/registration page
        function logout() {
            currentUser = null; // Clear user data
            location.reload(); // Reload the page to show the login/registration forms
        }

        // Handle registration
        document.getElementById('registerForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('reg_username').value;
            const password = document.getElementById('reg_password').value;
            const pokemonId = document.getElementById('reg_pokemon_id').value;

            axios.post('/register', { username, password, pokemon_id: pokemonId })
                .then(response => {
                    alert(response.data.message);
                    navigateToFeatures(response.data.username, response.data.pokemon_id, password);
                })
                .catch(error => alert('Error: ' + error.response.data.message));
        });

        // Handle login
        document.getElementById('loginForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const username = document.getElementById('login_username').value;
            const password = document.getElementById('login_password').value;

            axios.post('/login', { username, password })
                .then(response => {
                    alert(response.data.message);
                    navigateToFeatures(response.data.username, response.data.pokemon_id, password);
                })
                .catch(error => alert('Invalid username or password. Please try again.'));
        });

        // Offer Pokémon functionality
        function offerPokemon() {
            const actionArea = document.getElementById('actionArea');
            actionArea.innerHTML = `
                <h3>Offer a Pokémon</h3>
                <form id="offerPokemonForm">
                    <div class="mb-3">
                        <label for="offerPokemonName" class="form-label">Pokémon Name</label>
                        <input type="text" class="form-control" id="offerPokemonName" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Offer</button>
                </form>
                <h4 class="mt-4">Your Offered Pokémon</h4>
                <ul id="offeredPokemonList" class="list-group"></ul>
            `;

            fetchOfferedPokemon();

            document.getElementById('offerPokemonForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const pokemon = document.getElementById('offerPokemonName').value;

                axios.post('/pokemon/offer', { username: currentUser.username, pokemon })
                    .then(response => {
                        alert(response.data.message);
                        fetchOfferedPokemon();
                    })
                    .catch(error => alert('Error: ' + error.response.data.message));
            });
        }

        // Fetch offered Pokémon
        function fetchOfferedPokemon() {
            axios.get(`/pokemon/offered?username=${currentUser.username}`)
                .then(response => {
                    const offeredList = document.getElementById('offeredPokemonList');
                    offeredList.innerHTML = '';
                    response.data.forEach(offer => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            ${offer.pokemon}
                            <button class="btn btn-danger btn-sm" onclick="deleteOffer('${offer.id}')">Delete</button>
                        `;
                        offeredList.appendChild(listItem);
                    });
                })
                .catch(error => alert('Error fetching offered Pokémon.'));
        }

        // Delete Pokémon offer
        function deleteOffer(offerId) {
            axios.delete('/pokemon/offer/delete', { data: { offer_id: offerId } })
                .then(response => {
                    alert(response.data.message);
                    fetchOfferedPokemon();
                })
                .catch(error => alert('Error deleting offer: ' + error.response.data.message));
        }

        // Search Pokémon functionality
        function searchPokemon() {
            const actionArea = document.getElementById('actionArea');
            actionArea.innerHTML = `
                <h3>Search for a Pokémon</h3>
                <form id="searchPokemonForm">
                    <div class="mb-3">
                        <label for="searchPokemonName" class="form-label">Pokémon Name</label>
                        <input type="text" class="form-control" id="searchPokemonName" required>
                    </div>
                    <button type="submit" class="btn btn-success">Search</button>
                </form>
                <div id="searchResults" class="mt-3"></div>
            `;

            document.getElementById('searchPokemonForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const pokemon = document.getElementById('searchPokemonName').value;

                axios.get(`/pokemon/search?name=${pokemon}`)
                    .then(response => {
                        const resultsDiv = document.getElementById('searchResults');
                        resultsDiv.innerHTML = '<h4>Results:</h4>';
                        if (response.data.length > 0) {
                            response.data.forEach(result => {
                                resultsDiv.innerHTML += `<p>User ${result.username}, Pokémon ID: ${result.pokemon_id} offers ${result.pokemon}</p>`;
                            });
                        } else {
                            resultsDiv.innerHTML = '<p>No matches found.</p>';
                        }
                    })
                    .catch(error => alert('Error: ' + error.response.data.message));
            });
        }
    </script>
</body>
</html>